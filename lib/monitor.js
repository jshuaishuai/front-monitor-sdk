"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("js-cookie"),r=require("lodash-es");function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=t(e),n=function(e,r){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=r[t])})(e,r)};
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var i=function(){return(i=Object.assign||function(e){for(var r,t=1,o=arguments.length;t<o;t++)for(var n in r=arguments[t])Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n]);return e}).apply(this,arguments)};function c(e,r){for(var t=0,o=r.length,n=e.length;t<o;t++,n++)e[n]=r[t];return e}function a(e,r){for(var t in e)r[t]=e[t];return r}function s(e){return[].slice.call(e)}var u={wrap:g,wrapArgs:function(e){return function(){for(var r=[],t=0;t<arguments.length;t++)r[t]=arguments[t];r=s(arguments).map((function(e){return g(e)}));return e.apply(this,r)}}},d={handleTryCatchError:function(e){console.log(e)}};function g(e){return function(e){return"[object Function]"===Object.prototype.toString.call(e)}(e)?function(e){e._wrapped||(e._wrapped=function(){try{return e.apply(this,arguments)}catch(e){throw d.handleTryCatchError(e),window.ignoreError=!0,e}});return e._wrapped}(e):e}var f=[];f[1]={df:["url","http_code","during_ms","size"],ef:["params","response"],dft:{size:"response_size_b"}},f[2]={df:["url"],ef:["params","response"],dft:{}},f[3]={df:["url","reason"],ef:["code"],dft:{reason:"error_no"}},f[4]={df:["step"],ef:["desc"],dft:{step:"error_no"}},f[5]={df:["url","step"],ef:["params"],dft:{step:"error_no"}},f[8]={df:[],dft:{error_name:"error_no",http_code:"http_code",during_ms:"during_ms",url:"url",request_size_b:"request_size_b",response_size_b:"response_size_b"}};var p={1:"ERROR_RUNTIME",2:"ERROR_SCRIPT",3:"ERROR_STYLE",4:"ERROR_IMAGE",5:"ERROR_AUDIO",6:"ERROR_VIDEO",7:"ERROR_CONSOLE",8:"ERROR_TRY_CATCH"},l={1:"JS_RUNTIME_ERROR",2:"SCRIPT_LOAD_ERROR",3:"CSS_LOAD_ERROR",4:"IMAGE_LOAD_ERROR",5:"AUDIO_LOAD_ERROR",6:"VIDEO_LOAD_ERROR",7:"CONSOLE_ERROR",8:"TRY_CATCH_ERROR"},m={pid:"template",uuid:"uuid-"+Math.random(),ucid:"ucid-"+Math.random(),is_test:!0,record:{time_on_page:!0,performance:!0,js_error:!0,js_error_report_config:{ERROR_RUNTIME:!0,ERROR_SCRIPT:!0,ERROR_STYLE:!0,ERROR_IMAGE:!0,ERROR_AUDIO:!0,ERROR_VIDEO:!0,ERROR_CONSOLE:!0,ERROR_TRY_CATCH:!0,checkErrrorNeedReport:function(e,r){return void 0===e&&(e=""),void 0===r&&(r=""),console.log(e,r),!0}}},version:"1.0.0",getPageType:function(e){return void 0===e&&(e=window.location),""+e.host+e.pathname}};function v(e){var r=typeof e;return null!=e&&("object"==r||"function"==r)}var h={};h.get=r.get,h.has=r.has,h.clone=r.clone,h.isFunction=r.isFunction,h.merge=r.merge;var _=function(){};function b(e){var r=0,t=0;if(0===(e+="").length)return r.toString(36);for(t=0;t<e.length;t++)r=(r<<5)-r+e.charCodeAt(t),r|=0;return r.toString(36)}function R(){var e=o.default.get("crosSdkDT2019DeviceId");if(void 0===e){e=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(36).substring(1)}return b(1*new Date+"")+"-"+b(navigator.userAgent)+"-"+e()+e()+e()+e()+e()+"-"+e()+e()+e()}();var r=function(e){var r,t=new RegExp(/(.*?)\.?([^.]*?)\.(gl|com|net|org|biz|ws|in|me|co\.uk|co|org\.uk|ltd\.uk|plc\.uk|me\.uk|edu|mil|br\.com|cn\.com|eu\.com|hu\.com|no\.com|qc\.com|sa\.com|se\.com|se\.net|us\.com|uy\.com|ac|co\.ac|gv\.ac|or\.ac|ac\.ac|af|am|as|at|ac\.at|co\.at|gv\.at|or\.at|asn\.au|com\.au|edu\.au|org\.au|net\.au|id\.au|be|ac\.be|adm\.br|adv\.br|am\.br|arq\.br|art\.br|bio\.br|cng\.br|cnt\.br|com\.br|ecn\.br|eng\.br|esp\.br|etc\.br|eti\.br|fm\.br|fot\.br|fst\.br|g12\.br|gov\.br|ind\.br|inf\.br|jor\.br|lel\.br|med\.br|mil\.br|net\.br|nom\.br|ntr\.br|odo\.br|org\.br|ppg\.br|pro\.br|psc\.br|psi\.br|rec\.br|slg\.br|tmp\.br|tur\.br|tv\.br|vet\.br|zlg\.br|br|ab\.ca|bc\.ca|mb\.ca|nb\.ca|nf\.ca|ns\.ca|nt\.ca|on\.ca|pe\.ca|qc\.ca|sk\.ca|yk\.ca|ca|cc|ac\.cn|com\.cn|edu\.cn|gov\.cn|org\.cn|bj\.cn|sh\.cn|tj\.cn|cq\.cn|he\.cn|nm\.cn|ln\.cn|jl\.cn|hl\.cn|js\.cn|zj\.cn|ah\.cn|gd\.cn|gx\.cn|hi\.cn|sc\.cn|gz\.cn|yn\.cn|xz\.cn|sn\.cn|gs\.cn|qh\.cn|nx\.cn|xj\.cn|tw\.cn|hk\.cn|mo\.cn|cn|cx|cz|de|dk|fo|com\.ec|tm\.fr|com\.fr|asso\.fr|presse\.fr|fr|gf|gs|co\.il|net\.il|ac\.il|k12\.il|gov\.il|muni\.il|ac\.in|co\.in|org\.in|ernet\.in|gov\.in|net\.in|res\.in|is|it|ac\.jp|co\.jp|go\.jp|or\.jp|ne\.jp|ac\.kr|co\.kr|go\.kr|ne\.kr|nm\.kr|or\.kr|li|lt|lu|asso\.mc|tm\.mc|com\.mm|org\.mm|net\.mm|edu\.mm|gov\.mm|ms|nl|no|nu|pl|ro|org\.ro|store\.ro|tm\.ro|firm\.ro|www\.ro|arts\.ro|rec\.ro|info\.ro|nom\.ro|nt\.ro|se|si|com\.sg|org\.sg|net\.sg|gov\.sg|sk|st|tf|ac\.th|co\.th|go\.th|mi\.th|net\.th|or\.th|tm|to|com\.tr|edu\.tr|gov\.tr|k12\.tr|net\.tr|org\.tr|com\.tw|org\.tw|net\.tw|ac\.uk|uk\.com|uk\.net|gb\.com|gb\.net|vg|sh|kz|ch|info|ua|gov|name|pro|ie|hk|com\.hk|org\.hk|net\.hk|edu\.hk|us|tk|cd|by|ad|lv|eu\.lv|bz|es|jp|cl|ag|mobi|eu|co\.nz|org\.nz|net\.nz|maori\.nz|iwi\.nz|io|la|md|sc|sg|vc|tw|travel|my|se|tv|pt|com\.pt|edu\.pt|asia|fi|com\.ve|net\.ve|fi|org\.ve|web\.ve|info\.ve|co\.ve|tel|im|gr|ru|net\.ru|org\.ru|hr|com\.hr|ly|xyz)$/),o=e.match(t);if(o&&(r=o[2]?o[2]+"."+o[3]:void 0),void 0===r){var n=e.split(".");r=n.slice(n.length-2,n.length).join(".")}return r+""}(location.hostname);o.default.set("crosSdkDT2019DeviceId",e,{expires:1e3,domain:r}),e=o.default.get("crosSdkDT2019DeviceId")||""}return e}function w(e,r,t,o){void 0===o&&(o=console.log);var n=h.get(e,["record","js_error_report_config","checkErrorNeedReport"],h.get(m,["record","js_error_report_config","checkErrorNeedReport"])),i=!1;try{i=n(r,t)}catch(e){o("config.record.js_error_report_config.checkErrorNeedReport执行时发生异常, 请注意, 页面报错信息为=>",{e:e,desc:r,stack:t}),i=!0}return!!i}var y=function(e){console.log("%c "+e,"color:red")},O=function(e,r){void 0===r&&(r={});var t=f[e];if(t){var o=i({},{error_no:"",http_code:"",during_ms:"",url:"",request_size_b:"",response_size_b:""});return Object.keys(r).forEach((function(e){var n=t.dft[e];n?(o[n]=r[e],delete r[e]):o[e]=r[e]})),o}return r},E={tryJS:u,init:function(e){var r,t;!function(e){a(e,L),r=L.report,t=L.delay,o=function(){k=[]},n=null,j=function(){for(var e=this,i=[],c=0;c<arguments.length;c++)i[c]=arguments[c];clearTimeout(n),n=setTimeout((function(){r&&r.apply(e,i),o&&o()}),t)};var r,t,o,n}(e),window.addEventListener("error",(function(e){var r=e.target;r!==window&&r.nodeName&&T[r.nodeName.toUpperCase()]?I(function(e){return{type:T[e.nodeName.toUpperCase()],desc:e.baseURI+"@"+(e.src||e.href),stack:"no stack"}}(r)):I(function(e,r,t,o,n){return{type:1,desc:e+" at "+r+":"+t+":"+o,stack:n&&n.stack?n.stack:"no stack"}}(e.message,e.filename,e.lineno,e.colno,e.error))}),!0),console.error=(r=console,t=r.error,function(e){for(var o=[],n=1;n<arguments.length;n++)o[n-1]=arguments[n];var i={type:7,desc:e=v(e)?JSON.stringify(e,Object.getOwnPropertyNames(e)):e};t.call.apply(t,c([r,e],o)),I(i)})}};E.tryJS=u,a({handleTryCatchError:function(e){I(function(e){return{type:8,desc:e.message,stack:e.stack}}(e))}},d),window.ignoreError=!1;var k=[],j=function(){},L={concat:!0,delay:2e3,maxError:16,sampling:1},T={SCRIPT:2,LINK:3,IMG:4,AUDIO:5,VIDEO:6};function I(e){!L.concat&&L.report?!N(L.sampling)||L.report([e]):(!function(e){N(L.sampling)&&k.length<L.maxError&&k.push(e)}(e),j(k))}function N(e){return Math.random()<(e||1)}var D=window.fetch;function S(e,r){var t,o;t=e,o=r,D&&(window.fetch=function(e,r){return t(e,r),new Promise((function(t,n){D(e,r).then((function(e){return o(),t(e)})).catch((function(e){return o(),n(e)}))}))})}function z(e){var r=[],t=0,o=!0,n=Date.now(),i=window.MutationObserver||window.WebKitMutationObserver;if(i){var c,a=new i((function(e){var o=Date.now();n=o;for(var i=0,c=e;i<c.length;i++)for(var a=c[i].addedNodes,s=function(e){var n,i=a[e],c=(n=i,Object.prototype.toString.call(n).replace(/^\S+\s+/,"").replace(/]$/,""));if(/^HTML/.test(c)){var s={dom:i,time:o,domName:c};r.push(s),/Image/.test(c)&&(t++,i.addEventListener("load",(function(){t--,s.time=Date.now()}),!1))}},u=0;u<a.length;u++)s(u)}));a.observe(document,{attributes:!0,childList:!0,subtree:!0}),function i(){Date.now()>n+300&&0===t&&o?(!function(e,r){(window.requestAnimationFrame||window.setTimeout)((function(){var t=document.documentElement.clientHeight,o=document.documentElement.clientWidth,n=e.filter((function(e){var r=C(e.dom),n=r.left,i=r.top;return n<=o&&i<=t}));n.sort((function(e,r){return r.time-e.time}));var i=n[0]?n[0].time:0;r(i)}))}(r,e),a.disconnect()):o&&setTimeout(i,300)}(),c=function(){return o=!1},window.addEventListener("click",(function(){c()}),!0),window.addEventListener("keydown",(function(){c()}),!0),S((function(){return t++}),(function(){return t--}))}}function C(e,r,t){if(void 0===r&&(r=0),void 0===t&&(t=0),!e)return{left:r,top:t};var o=e.offsetLeft,n=void 0===o?0:o,i=e.offsetTop;return r+=n,t+=void 0===i?0:i,C(e.parentNode,r,t)}var P={init:function(e){var r=this,t=null,o=null;function n(){t&&o&&(t.firstScreenLoadingTime=o,r.debugLogger("发送页面性能指标数据, 上报内容 => ",i(i({},t),{url:""+window.location.host+window.location.pathname})),e&&e.call(r,"perf",20001,i(i({},t),{url:""+window.location.host+window.location.pathname})))}z((function(e){o=e,n()})),window.addEventListener("load",(function(){if(!1!==r.needRecordPerformance){var e=window.performance;if(e){for(var o in t={},e.timing)isNaN(e.timing[o])||(t[o]=e.timing[o]);n()}else r.debugLogger("你的浏览器不支持 performance 接口")}else r.debugLogger("config.record.performance值为false, 跳过性能指标打点")}))}},x=require("../package.json"),M=h.clone(m),A=new(function(e){function r(){return e.call(this)||this}return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function t(){this.constructor=e}n(e,r),e.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)}(r,e),r.prototype.set=function(){for(var r=[],t=0;t<arguments.length;t++)r[t]=arguments[t];e.prototype.init.apply(this,r)},r.prototype.behavior=function(e,r,t){void 0===e&&(e=""),void 0===r&&(r=""),void 0===t&&(t=""),this.debugLogger("发送用户点击行为埋点, 上报内容 => ",{code:e,name:r,url:t}),this.product(10002,{code:e,name:r,url:t})},r.prototype.notify=function(e,r,t){void 0===e&&(e=""),void 0===r&&(r=""),void 0===t&&(t={});var o={},n={};if(e){o.error_name=""+e,o.url=""+r,o.error_name.length>200&&(o.error_name=o.error_name.slice(0,200),this.debugLogger("error_name长度不能超过200字符, 自动截断. 截断后为=>",o.error_name)),o.url.length>200&&(o.url=o.url.slice(0,200),this.debugLogger("url长度不能超过200字符, 自动截断. 截断后为=>",o.error_name));for(var i=0,c=["http_code","during_ms","request_size_b","response_size_b"];i<c.length;i++){var a=c[i];if(h.has(t,[a])){var s=parseInt(t[a]);!1===isNaN(s)?o[a]=s:o[a]=0}}for(var u=0,d=Object.keys(t);u<d.length;u++){var g=d[u];!0!=={error_no:!0,error_name:!0,url:!0,http_code:!0,during_ms:!0,request_size_b:!0,response_size_b:!0}[g]&&(n[g]=t[g])}return this.debugLogger("发送自定义错误数据, 上报内容 => ",{detail:o,extra:n}),this.error(8,o,n)}console.log("dt.notify 的 errorName 不能为空")},r.prototype.logger=function(e,r,t){return void 0===e&&(e=""),void 0===r&&(r={}),void 0===t&&(t={}),e?"string"!=typeof e?this.debugLogger("【name属性】(打点事件名)仅支持字符串类型！"):(this.debugLogger("发送【event】类型埋点，事件名：【"+e+"】. 上报内容 => ",r),void this.send({type:"event",name:e,props:i({},r),extra:t})):this.debugLogger("警告: 未设置【name】(打点事件名)属性, 无法统计该打点数据！")},r.prototype.detect=function(e,r,t,o){var n=this;void 0===e&&(e=document.documentElement),void 0===r&&(r={}),void 0===t&&(t={}),void 0===o&&(o=_),h.isFunction(t)&&(o=t,t={});var i=r.errorName,c=void 0===i?"加载页面异常_WhiteScreen":i,a=r.url,s=void 0===a?""+location.host+location.pathname:a,u=r.extraInfo,d=void 0===u?{}:u;if(t=h.merge({subtree:!0,childList:!0,attributes:!1,characterData:!1,timeout:5e3},t),this.debugLogger("白屏检测配置: ====>",t,o),function(e){return"function"==typeof HTMLElement?e instanceof HTMLElement:e&&"object"==typeof e&&1===e.nodeType&&"string"==typeof e.nodeName}(e)){var g=t.timeout,f=void 0===g?5e3:g,p=t.childList,l=void 0===p||p,m=t.attributes,v=void 0!==m&&m,b=t.characterData;if(v||l||void 0!==b&&b){var R=window.MutationObserver||window.WebKitMutationObserver;if(!R)return y("您的浏览器不支持 MutationObserver API, 跳过白屏检测");var w=setTimeout((function(){n.notify(c,s,d),h.isFunction(o)&&o(O)}),f),O=void 0;return(O=new R((function(e){clearTimeout(w),h.isFunction(o)&&o(O,e)}))).observe(e,t),O}y("attributes childList characterData配置不合法, 跳过白屏检测")}else y("param [target] must be a instance of HTMLElement")},r}(function(){function e(){this.isTest=!0,this.isOverwrite=!1,this.needRecordJsError=!0,this.needRecordTimeOnPage=!0,this.needRecordPerformance=!0,this.config=Object.create(null)}return e.prototype.computeConfig=function(e){void 0===e&&(e={});var r=this.isOverwrite?i({},e):h.merge(M,e),t=h.get(r,["uuid"],"");""===t&&(t=R(),r.uuid=t),""===h.get(r,["ucid"],"")&&this.debugLogger("警告: 未设置ucid(用户唯一标识), 无法统计新增用户数");var o=h.get(r,["record","js_error_report_config","checkErrorNeedReport"]);!1===h.isFunction(o)&&(o=h.get(r,["record","js_error_report_config","checkErrorNeedReport"])),!1===h.isFunction(o)&&this.debugLogger("警告: config.record.js_error_report_config.checkErrorNeedReport 不是可执行函数, 将导致错误打点数据异常");var n=h.get(r,["getPageType"]);return!1===h.isFunction(n)&&this.debugLogger("警告: config.getPageType 不是可执行函数, 将导致打点数据异常!"),window.__dt_conf=r,(h.get(r,["is_test"],h.get(m,["is_test"]))||h.get(r,["test"],!1))&&(r.test="b47ca710747e96f1c523ebab8022c19e9abaa56b",this.debugLogger("配置更新完毕"),this.debugLogger("当前为测试模式"),this.debugLogger("Tip: 测试模式下打点数据仅供浏览, 不会展示在系统中"),this.debugLogger("更新后配置为:",r)),r},e.prototype.init=function(e,r){void 0===e&&(e=m),void 0===r&&(r=!1),this.isOverwrite=r,this.config=M=this.computeConfig(e),this.isTest=!!h.get(M,"test",!1),this.needRecordPerformance=h.get(M,["record","performance"],h.get(m,["record","performance"])),this.needRecordJsError=h.get(M,["record","js_error"],h.get(m,["record","js_error"])),this.needRecordTimeOnPage=h.get(M,["record","time_on_page"],h.get(m,["record","time_on_page"]));var t=this;E.init({concat:!1,report:function(e){if(void 0===e&&(e=[]),!1!==t.needRecordJsError)for(var r=0,o=e;r<o.length;r++){var n=o[r],i=n.type,c=n.desc,a=n.stack,s=h.get(p,i,"");if(!1!==h.get(M,["record","js_error_report_config",s],h.get(m,["record","js_error_report_config",s])))if(!1!=!!w(M,c,a,t.debugLogger.bind(t))){var u="页面报错_"+l[i],d=window.location;t.debugLogger("[自动]捕捉到页面错误, 发送打点数据, 上报内容 => ",{error_no:u,url:""+d.host+d.pathname,desc:c,stack:a}),t.log("error",7,{error_no:u,url:d.href},{desc:c,stack:a})}else t.debugLogger("config.record.js_error_report_config.checkErrorNeedReport返回值为false, 跳过此类错误, 页面报错信息为=>",{desc:c,stack:a});else t.debugLogger("config.record.js_error_report_config."+s+"值为false, 跳过类别为"+s+"的页面报错打点, 错误信息=>",n)}else t.debugLogger("config.record.js_error为false, 跳过页面报错打点, 页面报错内容为 =>",e)}}),P.init.bind(t)(t.log)},e.prototype.send=function(e){void 0===e&&(e={});var r=window.location,t=r.href,o=h.get(M,["getPageType"],h.get(m,["getPageType"]));try{t=""+o(r)}catch(e){this.debugLogger("config.getPageType执行时发生异常, 请注意, 错误信息=>",{e:e,location:r}),t=""+r.host+r.pathname}e=Object.assign({type:"",common:i(i({},M),{timestamp:Date.now(),runtime_version:M.version,sdk_version:x.version,page_type:t})},e),(new window.Image).src="http://39.106.100.186/dig.gif?d="+encodeURIComponent(JSON.stringify(e))},e.prototype.log=function(e,r,t,o){void 0===e&&(e=""),void 0===t&&(t={}),void 0===o&&(o={});var n=function(e,r,t,o,n){if(void 0===r&&(r=""),void 0===o&&(o={}),void 0===n&&(n={}),!h.get(e,["pid"],""))return"请设置工程ID[pid]";if("error"===r){if(t<0||t>9999)return"type:error的log code 应该在1～9999之间"}else if("product"===r){if(t<1e4||t>19999)return"type:product的log code 应该在10000～19999之间"}else if("info"===r&&(t<2e4||t>29999))return"type:info的log code 应该在20000～29999之间";if("object"!=typeof o)return"second argument detail required object";if("object"!=typeof n)return"third argument extra required object";var i=f[t];if(i){var a=c([],i.df),s=Object.keys(o),u=[];if(a.forEach((function(e){-1===s.indexOf(e)&&u.push(e)})),u.length)return"code: "+t+" 要求 "+u.join(",")+"字段必填"}return""}(M,e,r,t,o);if(n)return y(n),n;var i={type:e,code:r,extra:o,detail:O(r,t)};this.send(i)},e.prototype.error=function(e,r,t){return this.log("error",e,r,t)},e.prototype.product=function(e,r,t){return this.log("product",e,r,t)},e.prototype.info=function(e,r,t){return this.log("info",e,r,t)},e.prototype.debugLogger=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];this.isTest&&console.log.apply(console,e)},e}()));window.dt=A;var q=A.error.bind(A),U=A.product.bind(A),F=A.info.bind(A);exports.Elog=q,exports.Ilog=F,exports.Plog=U,exports.default=A;
